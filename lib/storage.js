import * as Carmentis from "./carmentis-nodejs-sdk.js";

const fileSystem  = Carmentis.core.storage.fileSystem;
const textEncoder = Carmentis.core.util.textEncoder;

let dir = fileSystem.directory("WALLET"),
    uid,
    encryptionKey;

// ============================================================================================================================ //
//  setUser()                                                                                                                   //
// ============================================================================================================================ //
export function setUser(userId) {
  uid = "walletFile" + userId;
}

// ============================================================================================================================ //
//  setKey()                                                                                                                    //
// ============================================================================================================================ //
export function setKey(key) {
  encryptionKey = key;
}

// ============================================================================================================================ //
//  exists()                                                                                                                    //
// ============================================================================================================================ //
export async function exists(file) {
  return await dir.byUid(uid, file).exists();
}

// ============================================================================================================================ //
//  readJson()                                                                                                                  //
// ============================================================================================================================ //
export async function readJson(file) {
  let data = await read(file);

  return JSON.parse(textEncoder.decode(data));
}

// ============================================================================================================================ //
//  read()                                                                                                                      //
// ============================================================================================================================ //
export async function read(file) {
  let encryptedData = await dir.byUid(uid, file).read();

  return await encryptionKey.decrypt(encryptedData);
}

// ============================================================================================================================ //
//  writeJson()                                                                                                                 //
// ============================================================================================================================ //
export async function writeJson(file, data) {
  let encodedData = textEncoder.encode(JSON.stringify(data));

  return await write("accounts", encodedData);
}

// ============================================================================================================================ //
//  write()                                                                                                                     //
// ============================================================================================================================ //
export async function write(file, data) {
  let encryptedData = await encryptionKey.encrypt(data);

  return await dir.byUid(uid, file).write(encryptedData);
}

// ============================================================================================================================ //
//  del()                                                                                                                       //
// ============================================================================================================================ //
export async function del(file) {
  return await dir.byUid(uid, file).del();
}
